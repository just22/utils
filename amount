#!/bin/sh

# ----------------------------------------------------------------------
#  $Id$
#
#  Automatic MOUNTer for OpenBSD
# ----------------------------------------------------------------------

_help() { less << __HELP__
NAME
  amount - Automatic MOUNTer

SYNOPSIS
  amount -h
  amount [-r dir] [-g group] [-m mode] [-e device] [-f program]

DESCRIPTION
  This script (un)mounts partitions of removable devices through a menu,
  then (optionally) opens a filemanager window.
  Notes:
  - specific for OpenBSD;
  - special permissions are needed for some commands (mount, fsck,
    chgrp, chmod), so it should be run through /usr/bin/doas

  The following options are available:

  -r dir       Mount root dir; it must exist and have the proper
               permissions (defaults to /vol);

  -g group     Mount dir will be owned by this group;

  -m mode      Mount dir will have these permissions;

  -e device    Do not manage these devices;

  -f program   Filemanager to be opened after mounting a partition

EXIT STATUS
  amount exits with one of the following values:
    0: Script completed with no error;
    1: Unknown option or missing argument;
    2: No removable devices;
    3: Cannot create mount dir;
    4: Unexpected fsck error.

AUTHOR
  Alessandro De Laurenzis, <just22@atlantide.mooo.com>
__HELP__
}

# ----------------------------------------------------------------------
# Command line argument parsing
#

# Defaults
MOUNT_ROOT=/vol
GROUP=diskmount
MODE=0775
EXCLUDED_DEV=""
FILEMGR="xfe"

while getopts ":hr:g:m:e:f:" arg; do
        case "$arg" in
        h)
                _help
                exit 0
                ;;
        r)
                MOUNT_ROOT="$OPTARG"
                ;;
        g)
                GROUP="$OPTARG"
                ;;
        m)
                MODE="$OPTARG"
                ;;
        e)
                EXCLUDED_DEV="$OPTARG"
                ;;
        f)
                FILEMGR="$OPTARG"
                ;;
        :)
                echo "${0##*/}: Option -$OPTARG requires an argument"
                exit 1
                ;;
        \?)
                echo "${0##*/}: Unknown option: -$OPTARG"
                exit 1
        esac
done
# ----------------------------------------------------------------------

NPART=0
for DISKNAME in $(sysctl -n hw.disknames | tr "," " "); do
        DEV=${DISKNAME%:*}
        if [ "${EXCLUDED_DEV#*$DEV}" == "$EXCLUDED_DEV" ]; then
                disklabel "$DEV" 2>/dev/null |&
                while read -p line; do
                        case "$line" in
                        disk:*)
                                # Mind: this way, there will be a leading space,
                                # but we need to preserve matching even when property
                                # is not defined (no chars after ":")
                                DISK="${line#disk:}"
                                ;;
                        label:*)
                                # Same as above
                                LABEL="${line#label:}"
                                ;;
                        a:*|d:*|e:*|f:*|g:*|h:*|i:*|j:*|k:*|l:*|m:*|n:*|o:*|p:*)
                                let ++NPART

                                # DEV_NAME is the dev's label (or disk name if the former is unset)
                                # (get rid of the leading space!)
                                DEV_NAME[$DEV]=${LABEL[$DEV]:-${DISK[$DEV]}}
                                DEV_NAME[$DEV]=${DEV_NAME[$DEV]# }

                                PART_NAME=${line%:*}
                                PART_TYPE="$(echo $line | awk '{print $4}')"

                                if [ "$PART_TYPE" != "unknown" ]; then
                                        if mount | grep -q "${DEV}${PART_NAME}"; then
                                                PART_ACTION="unmount"
                                        else
                                                PART_ACTION="mount"
                                        fi
                                        PART[$NPART]="$DEV,$DEV_NAME,$PART_NAME,$PART_TYPE,$PART_ACTION"
                                        ITEM[2*$NPART-1]="$NPART"
                                        ITEM[2*$NPART]="$DEV_NAME ($DEV) - Partition $PART_NAME ($PART_TYPE): $PART_ACTION"
                                fi
                                ;;
                        esac
                done
        fi
done

if [ ${#PART[*]} -eq 0 ]; then
        Xdialog \
                --buttons-style text \
                --screen-center \
                --title "Removable volume manager" \
                --msgbox "No removable devices \
                          or insufficient permissions" 5 60
        exit 2
fi

SEL=$(Xdialog \
        --buttons-style text \
        --rc-file /usr/local/share/Xdialog/fixed-font.rc \
        --no-tags \
        --screen-center \
        --stdout \
        --title "Removable volume manager" \
        --menubox "Select an action on available partitions" 15 90 1 "${ITEM[@]}")

if [ -n "$SEL" ]; then
        IFS="," read DEV DEV_NAME PART_NAME PART_TYPE PART_ACTION <<- EOT
		$(echo ${PART[$SEL]})
	EOT
        MOUNT_DIR="${MOUNT_ROOT}/${DEV_NAME}.${PART_NAME}"
        case "$PART_ACTION" in
        mount)
                [ -d "$MOUNT_DIR" ] || mkdir -m "$MODE" -p "$MOUNT_DIR" 2>/dev/null
                chgrp "$GROUP" "$MOUNT_DIR" 2>/dev/null
                if [ $? -ne 0 ]; then
                        Xdialog \
                                --buttons-style text \
                                --screen-center \
                                --left \
                                --title "Removable volume manager" \
                                --msgbox "Cannot create $MOUNT_DIR\nInsufficient permissions?" 7 60
                        exit 3
                fi

                case "$PART_TYPE" in
                4.2BSD)
                        MOUNT_OPT="-t ffs -o rw,nodev,nosuid,noatime"
                        RUN_FSCK=1
                        ;;
                MSDOS)
                        MOUNT_OPT="-t msdos -o rw,nodev,nosuid,noatime"
                        RUN_FSCK=0
                        ;;
                ext2fs)
                        MOUNT_OPT="-t ext2fs -o rw,nodev,nosuid,noatime"
                        RUN_FSCK=1
                        ;;
                UDF)
                        MOUNT_OPT="-t udf"
                        RUN_FSCK=0
                        ;;
                esac

                [ "$RUN_FSCK" == 1 ] && fsck -p -y /dev/"${DEV}${PART_NAME}" || true
                if [ $? -ne 0 ]; then
                        Xdialog \
                                --buttons-style text \
                                --screen-center \
                                --left \
                                --title "Removable volume manager" \
                                --msgbox "/dev/${DEV}${PART_NAME}: unexpected inconsistency\nPlease run fsck manually" 7 45
                        rm -r "$MOUNT_DIR"
                        exit 4
                else
                        mount $MOUNT_OPT /dev/"${DEV}${PART_NAME}" "$MOUNT_DIR"
                fi

                # $FILEMGR, when set, must be invoked as unprivileged user
                [ -n "$FILEMGR" ] && su ${DOAS_USER:-$USER} -c "$FILEMGR \"$MOUNT_DIR\" &"
                ;;

        unmount)
                for pid in $(fstat | grep "$MOUNT_DIR" | awk '{print $3}' | sort -u); do
                        kill -KILL "$pid"
                done
                umount "$MOUNT_DIR"
                rm -r "$MOUNT_DIR"
                ;;

        esac

fi

exit 0
