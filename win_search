#!/bin/sh

# ----------------------------------------------------------------------
#  $Id$
#
#  Perform a wmctrl action on selected window (by default, switch to
#  its desktop, raise and give it focus).
#  Dependencies: dmenu, wmctrl
# ----------------------------------------------------------------------

_usage() {
        echo "${0##*/} -h | [-z | -t] [wmctrl opt ...]"
        echo "-h: This message"
        echo "-z: Desktop id sequence starts from zero"
        echo "-t: Use tags instead of desktops (a-la-dwm)"
}

if [ "$1" == -h ]; then
        _usage
        exit 0
elif [ "$1" == -z ]; then
        d_inc=1
        shift
elif [ "$1" == -t ]; then
        tagmode=1
        shift
fi

win() {
        while IFS='' read line; do
                [ -z $last ] &&
                    w_lst="${line##*# }" ||
                    w_act="${line##*# }"
                last=1
        done <<- EOT
		$(xprop -root _NET_CLIENT_LIST _NET_ACTIVE_WINDOW)
	EOT

        IFS=", "
        for w_id in $w_lst; do
                [ "$w_id" == "$w_act" ] && tag="*" || tag=" "
                xprop -id "$w_id" |
                awk -v d_inc="${d_inc:-0}" \
                    -v tagmode="$tagmode" \
                    -v id="$w_id" \
                    -v tag="$tag" '
                        function tag2desk(t) {
                            i = 0
                            while(t) {
                                i++
                                b = t % 2
                                if (b) {d = d i " "}
                                t = int(t / 2)
                            }
                            return(d)
                        }
                        /^_NET_WM_WINDOW_TYPE/  {if (match($0, "DOCK|DESKTOP")) {exit}}

                        /window state/          {if (match($0, "Iconic")) {tag = "h"}}

                        /^WM_CLASS/             {if (match($0, "FvwmButtons")) {exit} {c = $4}}

                        /^WM_NAME/              {t = ""; for(i = 3; i <= NF; ++i) t = (t $i " ")}

                        /^_NET_WM_DESKTOP/      {if (tagmode) {
                                                        d = tag2desk($3);
                                                 } else {
                                                        d = "(" $3 + d_inc ")"
                                                 }
                                                }

                        /^CUST_WM_LABEL/        {split($3, l, /"/)}

                        END                     {if (c != "" && t != "")
                                                        printf("%9.9s %9s %s %-15s %-20.20s %s\n",
                                                             id, d, tag, "[" l[2] "]",
                                                             substr(c, 2, length(c) - 2),
                                                             substr(t, 2, length(t) - 3))
                                                }'

        done | dmenu-cust -p Win: -i -l 25
}

# main() {
        w_sel="$(win)"
        if [ -n "$w_sel" ]; then
                w_sel="${w_sel#"${w_sel%%[![:space:]]*}"}"
                wmctrl -i "${@--a}" "${w_sel%% *}"
        fi
# }

