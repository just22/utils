#!/bin/sh

# ----------------------------------------------------------------------
#  $Id$
#
#  Perform a wmctrl action on selected window (by default, switch to
#  its desktop, raise and give it focus).
#  Dependencies: dmenu, wmctrl
# ----------------------------------------------------------------------

_usage() {
        echo "${0##*/} -h | [-z | -t] [wmctrl opt ...]"
        echo "-h: This message"
        echo "-z: Desktop id sequence starts from zero"
        echo "-t: Use tags instead of desktops (a-la-dwm)"
}

if [ "$1" == -h ]; then
        _usage
        exit 0
elif [ "$1" == -z ]; then
        d_inc=1
        shift
elif [ "$1" == -t ]; then
        tagmode=1
        shift
fi

tag2desk() {
        local tag=$1
        local i=0
        local desk=""
        local r
        while [ $tag -ne 0 ]; do
                let "i = i + 1"
                let "r = tag % 2"
                [ $r -ne 0 ] && desk="${desk}${i} "
                let "tag = tag / 2"
        done
        echo $desk
}

win() {
        while IFS='' read line; do
                [ -z $last ] &&
                    w_lst="${line##*# }" ||
                    w_act="${line##*# }"
                last=1
        done <<- EOT
		$(xprop -root _NET_CLIENT_LIST _NET_ACTIVE_WINDOW)
	EOT

        IFS=", "
        for w_id in $w_lst; do
                [ "$w_id" == "$w_act" ] && tag="*" || tag=" "
                class=""; name=""; desk=""; label=""

                while IFS='' read line; do
                        case "$line" in
                        _NET_WM_WINDOW_TYPE*DOCK*|_NET_WM_WINDOW_TYPE*DESKTOP*)
                                continue 2
                                ;;
                        *window\ state*Iconic*)
                                tag="h"
                                ;;
                        WM_CLASS*)
                                class="${line##*, }"
                                class="${class#\"}"; class="${class%\"}"
                                ;;
                        WM_NAME*)
                                name="${line##*= }"
                                ;;
                        _NET_WM_DESKTOP*)
                                if [ "$tagmode" -eq 1 ]; then
                                        desk="$(tag2desk "${line##*= }")"
                                else
                                        let "desk = ${line##*= } + d_inc"
                                fi
                                ;;
                        CUST_WM_LABEL*)
                                label=${line##*= }
                                label="${label#\"}"; label="${label%\"}"
                        esac

                done <<- EOT
			$(xprop -id "$w_id")
		EOT

                if [ -n "$class" -a -n "$name" ]; then
                        printf "%9.9s %9s %s %-15s %-20.20s %s\n" \
                        "$w_id" "$desk" "$tag" "[$label]" "$class" "$name"
                fi

        done | dmenu-cust -p Win: -i -l 25
}

# main() {
        w_sel="$(win)"
        if [ -n "$w_sel" ]; then
                w_sel="${w_sel#"${w_sel%%[![:space:]]*}"}"
                wmctrl -i "${@--a}" "${w_sel%% *}"
        fi
# }
