#!/bin/sh

# ----------------------------------------------------------------------
#  $Id$
#
#  Change display settings using dmenu
# ----------------------------------------------------------------------

# No output msgs, please
exec >/dev/null 2>&1

_array() {
        case "$SH_VERSION" in
        *KSH*)
                a="$1"; shift
                set -A "$a" "$@"
                ;;
        *)
                eval $1='("${@:2}")'
        esac
}

_array MENU_ITEMS \
        "Off (LVDS-only)" \
        "Only (LVDS-off)" \
        "Left-of" \
        "Right-of" \
        "Above" \
        "Below"

wmrestart() {
        # Clean up statusbar
        if pgrep -x fluxbox; then
                pkill -x bbpager
                pkill -x space_dapp
                #pcmanfm --desktop-off
        fi

        # Change display layout
        if [ "$run_xrandr" -eq 1 ]; then
                xrandr $@

                [ "$norestart" -eq 1 ] && return

                # Restart window manager
                if pgrep -x fluxbox; then
                        sleep 2
                        fluxbox-remote Restart
                        sleep 2
                        fbsetbg -l
                elif pgrep -x dwm; then
                        [ -x ~/.fehbg ] && ~/.fehbg
                fi
        fi

        if pgrep -x fluxbox; then
                space_dapp $((($(screen-width) - 1))) 17 &
                dbar -xs "${xs:-1}" &
                sleep 1; bbpager &
                #pcmanfm --desktop &
        fi
}


# main() {

        if [ "$1" == -a ]; then
                run_xrandr=0
                wmrestart
                exit 0
        else
                run_xrandr=1
                if [ "$1" == -d ]; then
                        norestart=1;
                        shift
                fi
        fi

        # "Off" and "Only" are used for display init, skip all checks
        LVDS="$(xrandr -q | grep -w connected | awk '{print $1}' | grep LVDS)"
         VGA="$(xrandr -q | grep -w connected | awk '{print $1}' | grep VGA)"
        if [ "$1" != Off && "$1" != Only ]; then
                if [ -z "$LVDS" ] || [ -z "$VGA" ]; then
                        echo "No dual monitor configuration available" |
                        xmessage -center -title "dmenu-xrandr" \
                                -buttons "Close":0,"Reset Display":2 -file -
                        [ "$?" -eq 2 ] && wmrestart --auto
                        exit 1
                fi
        fi

        case "${1-$(printf "%s\n" "${MENU_ITEMS[@]}" | dmenu-cust -p VGA: "$@")}" in
        Off*)   [ -n "$LVDS" ] && (xs=1; wmrestart --output "$LVDS" --auto --output "$VGA" --off) ;;
        Only*)  [ -n "$VGA" ]  && (xs=1; wmrestart --output "$LVDS" --off  --output "$VGA" --auto) ;;
        Left*)  xs=1; wmrestart --output "$LVDS" --auto --output "$VGA" --primary --auto --left-of  "$LVDS" ;;
        Right*) xs=1; wmrestart --output "$LVDS" --primary --auto --output "$VGA" --auto --right-of "$LVDS" ;;
        Below)  xs=2; wmrestart --output "$LVDS" --auto --output "$VGA" --primary --auto --below    "$LVDS" ;;
        Above)  xs=2; wmrestart --output "$LVDS" --primary --auto --output "$VGA" --auto --above    "$LVDS" ;;
        *)      echo "${0##*/}: $1: unknown command"; exit 2
        esac

# }
